services:
  mesosphere-api:
    # Set MESOSPHERE_IMAGE to run a prebuilt image instead of local build output.
    image: ${MESOSPHERE_IMAGE:-local-mesosphere-api:latest}
    build:
      context: ${MESOSPHERE_BUILD_CONTEXT:-../..}
      dockerfile: ${MESOSPHERE_DOCKERFILE:-rust/Dockerfile}
    stop_grace_period: 10s
    stop_signal: SIGINT
    restart: unless-stopped
    ports:
      - "${MESOSPHERE_PUBLISH_PORT:-8000}:8000"
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      - MESOSPHERE_SERVER_PORT=8000
      - MESOSPHERE_API_KEY=${MESOSPHERE_API_KEY:-local-dev-key}
      - MESOSPHERE_MYSQL_URL=mysql://${MYSQL_USER:-mesosphere}:${MYSQL_PASSWORD:-mesosphere}@mysql:3306/${MYSQL_DATABASE:-mesosphere}
      - MESOSPHERE_MYSQL_POOL_MIN=${MESOSPHERE_MYSQL_POOL_MIN:-1}
      - MESOSPHERE_MYSQL_POOL_MAX=${MESOSPHERE_MYSQL_POOL_MAX:-10}
      - MESOSPHERE_LOG_LEVEL=${MESOSPHERE_LOG_LEVEL:-info}
      - MESOSPHERE_CORS_ORIGINS=${MESOSPHERE_CORS_ORIGINS:-*}
      - MESOSPHERE_VECTOR_MAX_DIM=${MESOSPHERE_VECTOR_MAX_DIM:-4096}
      - MESOSPHERE_QUERY_MAX_LIMIT=${MESOSPHERE_QUERY_MAX_LIMIT:-500}

  mysql:
    image: mysql:8.4
    stop_grace_period: 10s
    stop_signal: SIGINT
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE:-mesosphere}
      - MYSQL_USER=${MYSQL_USER:-mesosphere}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-mesosphere}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpassword}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mysqladmin ping -h localhost -p$${MYSQL_ROOT_PASSWORD} --silent",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    volumes:
      - mesosphere_mysql_data:/var/lib/mysql

  adminer:
    image: adminer:4
    stop_grace_period: 10s
    stop_signal: SIGINT
    restart: unless-stopped
    profiles: ["debug"]
    ports:
      - "${ADMINER_PUBLISH_PORT:-8080}:8080"

volumes:
  mesosphere_mysql_data:
